# Contributor: jv <jens@eisfair.org>
# Contributor: Adrian Guenter <adrian@gntr.me>
# Maintainer: jv <jens@eisfair.org>
pkgname=syslog-ng
pkgver=3.13.2
pkgrel=1
pkgdesc="Next generation logging daemon"
url="http://www.balabit.com"
arch="all !aarch64"
license="GPL-2.0"

depends=""
depends_dev="glib-dev
             pcre-dev
             libressl-dev
             python2-dev
             json-c-dev
             libcap-dev
             curl-dev
             hiredis-dev
             rabbitmq-c-dev
             libmaxminddb-dev
             libdbi-dev
             mongo-c-driver-dev"
makedepends="${depends_dev} file automake autoconf libtool"

install="${pkgname}.post-install"

subpackages="eventlog
             eventlog-dev:eventlog_dev
             ${pkgname}-extra
             ${pkgname}-extra-doc:extra_doc
             ${pkgname}-geoip2
             ${pkgname}-json
             ${pkgname}-python
             ${pkgname}-amqp
             ${pkgname}-http
             ${pkgname}-mongodb
             ${pkgname}-redis
             ${pkgname}-sql
             ${pkgname}-doc
             ${pkgname}-dev"

source="https://github.com/balabit/${pkgname}/releases/download/${pkgname}-${pkgver}/${pkgname}-${pkgver}.tar.gz
        syslog-ng.logrotate
        syslog-ng.initd
        syslog-ng-destination.std
        syslog-ng-filter.std
        syslog-ng-log.std
        syslog-ng-options.std
        syslog-ng-plugins.std
        syslog-ng-source.std"

builddir="${srcdir}/${pkgname}-${pkgver}"

prepare() {
    cd "$builddir"

    # getent module doesn't build properly as musl doesn't support reentrant
    # getprotoby[number|name] funcs. The provided compat lib only patches
    # solaris, which does provide reentrant versions under a different sig
    rm -rf ./modules/getent
    sed -i'' -E -e'/^include modules\/getent\//d' -e's/mod(ules?)?[-_]getent //' ./modules/Makefile.am

    aclocal
}

build() {
    cd "$builddir"

    ./configure \
        --prefix=/usr \
        --localstatedir=/var \
        --sysconfdir=/etc/$pkgname \
        --with-gnu-ld \
        --enable-extra-warnings \
        --enable-manpages \
        --enable-linux-caps \
        --enable-ipv6 \
        --enable-ssl \
        --enable-geoip2 \
        --enable-json \
        --with-jsonc=system \
        --enable-amqp \
        --with-librabbitmq-client=system \
        --enable-http \
        --enable-mongodb \
        --with-mongoc=system \
        --enable-redis \
        --enable-sql \
        --disable-java \
        --disable-java-modules

    make
}

check() {
    cd "$builddir"

    make check || true
}

package() {
    make -C "$builddir" -j1 DESTDIR="$pkgdir" install

    cd "$pkgdir"

    rmdir ./var

    mv ./etc/$pkgname/syslog-ng.conf ./etc/$pkgname/syslog-ng.conf.default

    install -D -m755 "$srcdir"/$pkgname.initd            ./etc/init.d/$pkgname
    install -D -m644 "$srcdir"/syslog-ng-destination.std ./etc/syslog-ng/syslog-ng-destination.std
    install -D -m644 "$srcdir"/syslog-ng-filter.std      ./etc/syslog-ng/syslog-ng-filter.std
    install -D -m644 "$srcdir"/syslog-ng-log.std         ./etc/syslog-ng/syslog-ng-log.std
    install -D -m644 "$srcdir"/syslog-ng-options.std     ./etc/syslog-ng/syslog-ng-options.std
    install -D -m644 "$srcdir"/syslog-ng-plugins.std     ./etc/syslog-ng/syslog-ng-plugins.std
    install -D -m644 "$srcdir"/syslog-ng-source.std      ./etc/syslog-ng/syslog-ng-source.std
    install -D -m644 "$srcdir"/syslog-ng.logrotate       ./etc/logrotate.d/syslog-ng
}

_eventlogdesc="API to format and send structured log messages"

eventlog() {
    pkgdesc="$_eventlogdesc"

    _submv usr/lib/libevtlog-*.so*
}

eventlog_dev() {
    pkgdesc="${_eventlogdesc} (development files)"

    _submv usr/include/$pkgname/evt* \
           usr/lib/libevtlog.*
}

_extradesc="Extra utilities and support files for ${pkgname}"

extra() {
    pkgdesc="$_extradesc"

    _submv etc/$pkgname/patterndb* \
           etc/$pkgname/scl.conf \
           etc/$pkgname/syslog-ng.conf.default \
           usr/bin/dqtool \
           usr/bin/loggen \
           usr/bin/pdbtool \
           usr/bin/update-patterndb \
           usr/sbin/syslog-ng-debun \
           usr/share/$pkgname/include/scl \
           usr/share/$pkgname/tools \
           usr/share/$pkgname/xsd/patterndb*
}

extra_doc() {
    pkgdesc="${_extradesc} (documentation)"

    _submv usr/share/man/man1/dqtool.* \
           usr/share/man/man1/loggen.* \
           usr/share/man/man1/pdbtool.* \
           usr/share/man/man1/syslog-ng-debun.*
}

geoip2() {
    pkgdesc="GeoIP2/MMDB parsing plugin for ${pkgname}"

    _submv usr/lib/$pkgname/libgeoip2-plugin.so
}

json() {
    pkgdesc="JSON parsing and formatting plugin for ${pkgname}"

    _submv usr/lib/$pkgname/libjson-plugin.so
}

python() {
    pkgdesc="Python destination module for ${pkgname}"

    _submv usr/lib/python* \
           usr/lib/$pkgname/libmod-python.so
}

amqp() {
    pkgdesc="AMQP/RabbitMQ destination module for ${pkgname}"

    _submv usr/lib/$pkgname/libafamqp.so
}

http() {
    pkgdesc="HTTP destination module for ${pkgname}"

    _submv usr/lib/$pkgname/libhttp.so
}

mongodb() {
    pkgdesc="MongoDB destination module for ${pkgname}"

    _submv usr/lib/$pkgname/libafmongodb.so
}

redis() {
    pkgdesc="Redis destination module for ${pkgname}"

    _submv usr/lib/$pkgname/libredis.so
}

sql() {
    pkgdesc="SQL destination module for ${pkgname}"

    _submv usr/lib/$pkgname/libafsql.so
}

_submv() {
    cd "$pkgdir"
    local path; for path in "$@"; do
        mkdir -p "${subpkgdir}/${path%/*}"
        mv ./${path} "${subpkgdir}/${path%/*}"
        # Try to recursively remove the now potentially empty parent directory of $path
        rmdir -p ./"${path%/*}" 2>/dev/null >&2 || true
    done
}

sha512sums="fd5c6645f1e8e10cba940ea29715f9e7cc286cd49c2f45bde2a447731189d6171ca204aa066ac96dd09246fd7ed1751130d143d807c979518d688e7750490cfe  syslog-ng-3.13.2.tar.gz
a062d1601f5215f60e2fc40c6ca498d768aa97af3647a9468731123a28fdd67962421b4412bfbe08a1123141b730cb78f102230ab72befec05ba7f398b39e27a  syslog-ng.logrotate
7ff0e606b9b0b1f9afaf37bf44c26d55dcec9d343e3400817059feb8da84c47279d838337aa95e1615bf190483c965cd795b722eb5358c7f155693abb2800040  syslog-ng.initd
b51d8b3da9584b6cb5b5c023b5ca1085d8e4c2cfa56f6ed12fe6feb0f33a390b43825aaaf4dd74eb6b7765485fe42f7f21c74380b72de9ed2c7775787ab1e720  syslog-ng-destination.std
e04a70a0b8fc4f40951c9b608b0dede1fa561dd7f58ce8fd8bac70b578b749d15d202973fd9de9fe494656ee138ef5efd32ea6229e6ec0a2f19672dd621acc91  syslog-ng-filter.std
d7864f6666101e0818dd0178a4d1ada2417280de153ff916fe4879348a37b7bfab5936e86629dc52e4edf82fbd601e04d08ed5a2117bcb0470a3d5884add9f55  syslog-ng-log.std
9f4224faf45c73daa54549aebf20e2c45d0bf533a20d2ad97d7258490ce793c8b08cc34cac2a89d185e936515096eb93c793018986c8d21861d88c4b0005d16a  syslog-ng-options.std
5cf6709c29f393eecb13fade92d439f6a8a980df2e6db1cf602060f583ad0e26566cc1a4c6f7d587af514ceacdfd4529fe1c87063fe491f3d7e02f4799977bca  syslog-ng-plugins.std
b441689ded539a358bf03fc292721a280ea29e1592b2a10ce011b455643dae3949af239a0f2bf84957096757e55a87e844df10c0be016fb7ac969d53def6afc6  syslog-ng-source.std"
